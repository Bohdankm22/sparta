<?xml version="1.0" encoding="UTF-8"?>
<project name="checkers" default="debug">

    <condition property="jdkName" value="jdk7.jar" else="jdk6.jar">
        <contains string="${java.version}" substring="1.7"/>
    </condition>

    <presetdef name="jsr308.javac">
    <javac fork="yes" executable="${checkers_dir}/${checkers_base}/binary/javac">
      <!-- JSR308 related compiler arguments -->
      <compilerarg value="-version"/>
      <!-- optional, so .class files work with older JVMs: <compilerarg line="-target 5"/> -->
      <compilerarg value="-implicit:class"/>
      <!-- optional, to issue warnings instead of errors: <compilerarg line="-Awarns -Xmaxwarns 10000"/> -->
	<compilerarg line="-Awarns -Xmaxwarns 10000"/>
<!-- Used to connect with the eclipse debugger	<compilerarg line="-J-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=8000"/> -->
        <!--<compilerarg value="-J-Xbootclasspath/p:${checkers}/binary/jsr308-all.jar"/>

      <classpath>
        <pathelement location="${checkers}/binary/checkers.jar"/>
      </classpath>-->
    </javac>
    </presetdef>
    
    
    <!--depends="-set-release-mode, -release-obfuscation-check, -package, -post-package, -release-prompt-for-password, -release-nosign, -release-sign, -post-build"-->

    <!-- Apply a type processor to all files in the project. -->
    <macrodef name="process-proj">
        <!-- The processor to apply. -->
        <attribute name="processor"/>
        <attribute name="stub" default="${stubs}"/>
         <attribute name="flowPolicy" default="${flowPolicy}"/>
         <attribute name="componentMap" default="${componentMap}"/>
         <attribute name="ignorenr" default="${ignorenr}"/>
        <!-- Optional additional tasks to perform at the end. -->
        <element name="more-tasks" optional="yes"/>
        <sequential>
            <condition property="extensible.libs.classpath"
                   value="${tested.project.absolute.dir}/${jar.libs.dir}"
                   else="${jar.libs.dir}">
                <isset property="tested.project.absolute.dir" />
            </condition>
            <!-- Option to show all subtyping tests. -->
            <condition property="showchecks"
                   value="-Ashowchecks -AprintErrorStack"
                   else="">
                <equals arg1="${debug}" arg2="true" />
            </condition>

            <condition property="checkerFrameworkOpts" value="${cfOpts}" else="">
                <isset property="cfOpts"/>
            </condition>

            <!-- Option to enforce stricter checks, in particular for casts. -->
            <!-- Note that only one -Alint argument can be provided. -->
            <condition property="strictoptions"
                   value="-AcheckCastElementType -AinvariantArrays -Alint=strict-conditional"
                   else="">
                <or>
                    <equals arg1="${stricter}" arg2="true" />
                    <equals arg1="${sound}" arg2="true" />                
                </or>
            </condition>

            <!--classpathref="android.target.classpath"-->
            <jsr308.javac
                   destdir="${out.classes.absolute.dir}"
                   classpathref="project.target.class.path"
                   includeantruntime="false">
                <src path="${source.absolute.dir}" />
                <src path="${gen.absolute.dir}" />
                <classpath>
                    <fileset dir="${extensible.libs.classpath}" includes="*.jar" />
                    <pathelement location="${sparta-code_dir}/${sparta-code_base}/sparta.jar"/>
                </classpath>
                <compilerarg line="${java.compilerargs} ${showchecks} ${strictoptions}" />
                <compilerarg line=" -processor @{processor} -Astubs=@{stub} -AflowPolicy=@{flowPolicy} -AcomponentMap=@{componentMap} -Aignorenr=@{ignorenr} ${checkerFrameworkOpts}"/>
                <compilerarg line="-encoding ISO8859-1 -AprintErrorStack -AsuppressWarnings=purity.invalid.overriding " />
            </jsr308.javac>
            <more-tasks/>
        </sequential>
    </macrodef>

    <macrodef name="javamain-proj">
        <!-- The class with main to apply. -->
        <attribute name="classname"/>
        <!-- The output from java goes here. -->
        <attribute name="output"/>
        <!-- Optional additional tasks to perform at the end. -->
        <element name="more-tasks" optional="yes"/>
        <sequential>
            <condition property="extensible.libs.classpath"
                    value="${tested.project.absolute.dir}/${jar.libs.dir}"
                    else="${jar.libs.dir}">
                <isset property="tested.project.absolute.dir" />
            </condition>

            <property name="classpath"
                value="${checskers_dir}/${checkers_base}/binary/${jdkName}:${checkers_dir}/${checkers_base}/javac.jar:${checkers_dir}/${checkers_base}/binary/checkers.jar:${sparta-code_dir}/${sparta-code_base}/bin/::${sparta-code_dir}/${sparta-code_base}/build/:${sparta-code_dir}/${sparta-code_base}/sparta.jar:${sparta-code_dir}/${sparta-code_base}/lib/google-gson-2.2.2/gson-2.2.2.jar"/>

            <fileset dir="${source.absolute.dir}" id="mySourceJava">
                <include name="**/*.java" />
            </fileset>
            <pathconvert property="cmdSourceJava" refid="mySourceJava" pathsep="' '" />

            <fileset dir="${gen.absolute.dir}" id="myGenJava">
                <include name="**/*.java" />
            </fileset>
            <pathconvert property="cmdGenJava" refid="myGenJava" pathsep="' '" />

            <java fork="true" classname="@{classname}"
                output="@{output}">
                <arg line="'${cmdSourceJava}'"/>
                <arg line="'${cmdGenJava}'"/>
                <classpath>
                    <fileset dir="${extensible.libs.classpath}" includes="*.jar" />
                </classpath>
                <classpath refid="project.target.class.path" />

                <jvmarg value="-Xbootclasspath/p:${classpath}"/>

                <env key="CLASSPATH" value="${classpath}"/>
            </java>
            <echo>Result written to @{output}</echo>
            <more-tasks/>
        </sequential>
    </macrodef>

    <target name="-setup-check-flow">
        <property name="build.target" value="check-flow" />
    </target>
    
    <target name="check-intent"
                depends="clean,-setup-check-flow, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="check for check-intent.">
        <process-proj ignorenr="on" processor="sparta.checkers.intents.IntentChecker"/>
    </target>

    <target name="check-flow"
                depends="clean,-setup-check-flow, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="check for check-flow.">
        <process-proj processor="sparta.checkers.FlowChecker"/>
    </target>
    
    <target name="check-value"
                depends="clean, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="run the Value Checker">
        <process-proj processor="checkers.value.ValueChecker"/>
    </target>
    
    <target name="filter-flows">
        <property name="filter.flow_file" value="./forbiddenFlowLocations.txt" />
        <property name="filter" value="" />
        <exec executable="${sparta-code_dir}/${sparta-code_base}/filter-flows.pl">
                    <arg line="--flow-file ${filter.flow_file}" />
                    <arg line="--filter '${filter}'" />
        </exec><echo/>
    </target>

    <target name="capture-strings"
                depends="clean,-setup-check-flow, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="capture string literals.">
                <property name="capture.dirs" value="src AndroidManifest.xml" />
                <property name="capture.outfile" value="sparta_strings.txt" />
                <echo>Capture string literals from source</echo><echo/>
                <exec executable="${sparta-code_dir}/${sparta-code_base}/capture-strings.pl">
                    <arg line="--dirs '${capture.dirs}'" />
                    <arg line="--outfile ${capture.outfile}" />
                </exec><echo/>
    </target>
    
    <target name="compare-strings"
                depends="clean,-setup-check-flow, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="compare string literals.">
                <property name="compare.source_strings" value="sparta_strings.txt" />
                <property name="compare.search_file" value="sparta_strings.txt" />
                <echo>Compare string literals from other packages</echo><echo/>
                <exec executable="${sparta-code_dir}/${sparta-code_base}/compare-strings.pl">
                    <arg line="--source-strings ${compare.source_strings}"/>
                    <arg line="--search_file ${compare.search_file}"/>
                    <arg line="--root-dir ${compare.root}"/>
                </exec><echo/>
    </target>

    <target name="check-flow-ignorenr"
                depends="clean,-setup-check-flow, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="runs the flow checker but ignores NOT_REVIEWED warnings from methods that are not annotated in the stubfiles.">
        <process-proj ignorenr="on" processor="sparta.checkers.FlowChecker"/>
    </target>

    <target name="conditiontest"
            depends="clean, -build-setup,-set-release-mode,-code-gen, -post-package"
            description="Test program conditions for types that flow to conditions and do not contain the @FlowPermission.CONDITIONAL flow-sink.">
        <property name="cfOpts" value="-AmsgFilter=condition.flow"/>
        <process-proj processor="sparta.checkers.FlowChecker"/>
    </target>
    
        <target name="check-conditionals"
            depends="clean, -build-setup,-set-release-mode,-code-gen, -post-package"
            description="Output all the locations a non-literal source is used in a conditional regardless of the flow policy.">
        <property name="cfOpts" value="-Acheckconditionals=true"/>
        <process-proj processor="sparta.checkers.FlowChecker"/>
    </target>

    <target name="-setup-reqperms">
        <property name="build.target" value="reqperms" />
    </target>

    <target name="check-permissions"
                depends="clean,-setup-reqperms,-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="check for both required permissions and dependent permissions.">
        <process-proj processor="sparta.checkers.PermissionsChecker"/>
    </target>

    <target name="reqperms"
                depends="clean,-setup-reqperms,-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="check for required permissions.">
        <process-proj processor="sparta.checkers.RequiredPermissionsChecker"/>
    </target>

    <target name="reqdependentperms"
                depends="clean,-setup-reqperms,-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="check for dependent permissions.">
        <process-proj processor="sparta.checkers.DependentPermissionsChecker"/>
    </target>



    <target name="flowshow"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="show the flow annotations in the code.">
        <process-proj processor="sparta.checkers.FlowShow"/>
    </target>

    <target name="flowshow-json"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="show the flow annotations in the code with JSON.">
        <javamain-proj classname="sparta.checkers.JsonJavac$FlowShowJson"
            output="flowshow.json"/>
    </target>

    <target name="-setup-reportsuspicious">
        <property name="build.target" value="reportsuspicious" />
    </target>

    <target name="reportsuspicious"
                depends="clean, -setup-reportsuspicious, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report suspicoius API usage.">
        	<!-- Run script to search for suspicious regexp pattern -->
        		<echo>Search for suspicious regexp pattern</echo><echo/>        		
                <exec executable="${sparta-code_dir}/${sparta-code_base}/suspicious.pl">
                      <arg value="."/>
                </exec><echo/>
            <!-- Run report checker -->
                <process-proj processor="sparta.checkers.AndroidReportChecker" stub="suspicious.astub"/>
    </target>

    <target name="reportapiusage"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report interesting API usage.">
        <process-proj processor="sparta.checkers.AndroidReportChecker" stub="apiusage.astub"/>
    </target>
    
    
       <target name="count-locations"
                depends="clean, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="Counts the number of places that could be annotated.">
        <process-proj processor="checkers.util.count.Locations" stub=""/>
       </target>
          
               <target name="count-annotations"
                depends="clean, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="Counts the number of annotations in the app.">
        <process-proj processor="checkers.util.count.AnnotationsCounter" stub=""/>
    </target>

<!-- no longer in use
    <target name="reportusage-json"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report interesting API usage with JSON.">
        <javamain-proj classname="sparta.checkers.JsonJavac$ReportUsageJson"
            output="reportusage.json"/>
    </target>

    <target name="reportusage-text"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report interesting API usage as text.">
        <javamain-proj classname="sparta.checkers.JsonJavac$ReportUsageText"
            output="reportusage.txt"/>
    </target>
-->

    <target name="reportbinaryonly"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report binary-only method calls and field accesses.">
        <process-proj processor="sparta.checkers.ReportBinaryChecker"/>
    </target>
    

</project>

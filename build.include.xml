<?xml version="1.0" encoding="UTF-8"?>
<project name="checkers" default="debug">

    <condition property="jdkName" value="jdk7.jar" else="jdk6.jar">
        <contains string="${java.version}" substring="1.7"/>
    </condition>

    <presetdef name="jsr308.javac">
    <javac fork="yes" executable="${checkers_dir}/${checkers_base}/binary/javac">
      <!-- JSR308 related compiler arguments -->
      <compilerarg value="-version"/>
      <!-- optional, so .class files work with older JVMs: <compilerarg line="-target 5"/> -->
      <compilerarg value="-implicit:class"/>
      <!-- optional, to issue warnings instead of errors: <compilerarg line="-Awarns -Xmaxwarns 10000"/> -->
      <!--<compilerarg value="-J-Xbootclasspath/p:${checkers}/binary/jsr308-all.jar"/>

      <classpath>
        <pathelement location="${checkers}/binary/checkers.jar"/>
      </classpath>-->
    </javac>
    </presetdef>
    <!--depends="-set-release-mode, -release-obfuscation-check, -package, -post-package, -release-prompt-for-password, -release-nosign, -release-sign, -post-build"-->

    <!-- Apply a type processor to all files in the project. -->
    <macrodef name="process-proj">
        <!-- The processor to apply. -->
        <attribute name="processor"/>
        <attribute name="stub" default="${stubs}"/>
         <attribute name="flowPolicy" default="${flowPolicy}"/>
        <!-- Optional additional tasks to perform at the end. -->
        <element name="more-tasks" optional="yes"/>
        <sequential>
            <condition property="extensible.libs.classpath"
                   value="${tested.project.absolute.dir}/${jar.libs.dir}"
                   else="${jar.libs.dir}">
                <isset property="tested.project.absolute.dir" />
            </condition>
            <!-- Option to show all subtyping tests. -->
            <condition property="showchecks"
                   value="-Ashowchecks -AprintErrorStack"
                   else="">
                <equals arg1="${debug}" arg2="true" />
            </condition>

            <condition property="checkerFrameworkOpts" value="${cfOpts}" else="">
                <isset property="cfOpts"/>
            </condition>

            <!-- Option to enforce stricter checks, in particular for casts. -->
            <!-- Note that only one -Alint argument can be provided. -->
            <condition property="lintoptions"
                   value="-Alint=cast:strict,arrays,strict-conditional:invariant"
                   else="">
                <or>
                    <equals arg1="${stricter}" arg2="true" />
                    <equals arg1="${sound}" arg2="true" />                
                </or>
            </condition>

            <!--classpathref="android.target.classpath"-->
            <jsr308.javac
                   destdir="${out.classes.absolute.dir}"
                   classpathref="project.target.class.path"
                   includeantruntime="false">
                <src path="${source.absolute.dir}" />
                <src path="${gen.absolute.dir}" />
                <classpath>
                    <fileset dir="${extensible.libs.classpath}" includes="*.jar" />
                    <pathelement location="${sparta-code_dir}/${sparta-code_base}/sparta.jar"/>
                </classpath>
                <compilerarg line="${java.compilerargs} ${showchecks} ${lintoptions}" />
                <compilerarg line=" -processor @{processor} -Astubs=@{stub} -AflowPolicy=@{flowPolicy} ${checkerFrameworkOpts}"/>
                <compilerarg line="-encoding ISO8859-1 -AprintErrorStack -AstubWarnIfNotFound" />
            </jsr308.javac>
            <more-tasks/>
        </sequential>
    </macrodef>

    <macrodef name="javamain-proj">
        <!-- The class with main to apply. -->
        <attribute name="classname"/>
        <!-- The output from java goes here. -->
        <attribute name="output"/>
        <!-- Optional additional tasks to perform at the end. -->
        <element name="more-tasks" optional="yes"/>
        <sequential>
            <condition property="extensible.libs.classpath"
                    value="${tested.project.absolute.dir}/${jar.libs.dir}"
                    else="${jar.libs.dir}">
                <isset property="tested.project.absolute.dir" />
            </condition>

            <property name="classpath"
                value="${checskers_dir}/${checkers_base}/binary/${jdkName}:${checkers_dir}/${checkers_base}/javac.jar:${checkers_dir}/${checkers_base}/binary/checkers.jar:${sparta-code_dir}/${sparta-code_base}/bin/::${sparta-code_dir}/${sparta-code_base}/build/:${sparta-code_dir}/${sparta-code_base}/sparta.jar:${sparta-code_dir}/${sparta-code_base}/lib/google-gson-2.2.2/gson-2.2.2.jar"/>

            <fileset dir="${source.absolute.dir}" id="mySourceJava">
                <include name="**/*.java" />
            </fileset>
            <pathconvert property="cmdSourceJava" refid="mySourceJava" pathsep="' '" />

            <fileset dir="${gen.absolute.dir}" id="myGenJava">
                <include name="**/*.java" />
            </fileset>
            <pathconvert property="cmdGenJava" refid="myGenJava" pathsep="' '" />

            <java fork="true" classname="@{classname}"
                output="@{output}">
                <arg line="'${cmdSourceJava}'"/>
                <arg line="'${cmdGenJava}'"/>
                <classpath>
                    <fileset dir="${extensible.libs.classpath}" includes="*.jar" />
                </classpath>
                <classpath refid="project.target.class.path" />

                <jvmarg value="-Xbootclasspath/p:${classpath}"/>

                <env key="CLASSPATH" value="${classpath}"/>
            </java>
            <echo>Result written to @{output}</echo>
            <more-tasks/>
        </sequential>
    </macrodef>

    <target name="flowtest"
                depends="clean, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="check for flowtest.">
        <process-proj processor="sparta.checkers.FlowChecker"/>
    </target>

    <target name="conditiontest"
            depends="clean, -build-setup,-set-release-mode,-code-gen, -post-package"
            description="Test program conditions for types that flow to conditions and do not contain the @FlowSink.CONDITIONAL flow-sink.">
        <property name="cfOpts" value="-AmsgFilter=condition.flow"/>
        <process-proj processor="sparta.checkers.FlowChecker"/>
    </target>

    <target name="reqperms"
                depends="clean, -build-setup,-set-release-mode,-code-gen, -post-package" 
                description="check for required permissions.">
        <process-proj processor="sparta.checkers.PermissionsChecker"/>
    </target>


    <target name="flowshow"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="show the flow annotations in the code.">
        <process-proj processor="sparta.checkers.FlowShow"/>
    </target>

    <target name="flowshow-json"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="show the flow annotations in the code with JSON.">
        <javamain-proj classname="sparta.checkers.JsonJavac$FlowShowJson"
            output="flowshow.json"/>
    </target>

    <target name="reportsuspicious"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report suspicoius API usage.">
        	<!-- Run script to search for suspicious regexp pattern -->
        		<echo>Search for suspicious regexp pattern</echo><echo/>        		
                <exec executable="${sparta-code_dir}/${sparta-code_base}/suspicious.pl">
                      <arg value="."/>
                </exec><echo/>
            <!-- Run report checker -->
                <process-proj processor="sparta.checkers.AndroidReportChecker" stub="suspicious.astub"/>
    </target>

    <target name="reportapiusage"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report interesting API usage.">
        <process-proj processor="sparta.checkers.AndroidReportChecker" stub="apiusage.astub"/>
    </target>

<!-- no longer in use
    <target name="reportusage-json"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report interesting API usage with JSON.">
        <javamain-proj classname="sparta.checkers.JsonJavac$ReportUsageJson"
            output="reportusage.json"/>
    </target>

    <target name="reportusage-text"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report interesting API usage as text.">
        <javamain-proj classname="sparta.checkers.JsonJavac$ReportUsageText"
            output="reportusage.txt"/>
    </target>
-->

    <target name="reportbinaryonly"
                depends="-build-setup,-set-release-mode,-code-gen, -post-package" 
                description="report binary-only method calls and field accesses.">
        <process-proj processor="sparta.checkers.ReportBinaryChecker"/>
    </target>

</project>

\htmlhr
\chapter{Tips for writing information flow annotations\label{app-annotation}}

This chapter contains tips for annotating an Android application.

In general, only fields and methods signatures in your own code and in
libraries need to be annotated. Usually method bodies do not need to be
annotated.


\section{Annotating Application Methods\label{sec:annomethods}}

Typically, return types should be annotated with just Sources so that the Sinks can be
 inferred from the policy file as explained in Section \ref{flow-defaults}. Similarly, parameters should
  only be annotated with Sinks, so that the Sources can be inferred from  the policy file.
    Local variables should not have to be annotated, because their types can be inferred. Fields 
    must be annotated with  Sinks or Sources, or sometimes both. 

\section{Annotating APIs in Stub Files\label{sec:annoAPI}}
\todo{We are changing the defaulting for APIs, so this section will need to be completely  rewritten once that is done.}

\subsection{Methods with Sources}
If you read the Javadoc and the method returns an object from a certain source, then you should annotate
the return type with that flow source and with \<@Sinks(SpartaPermission.ANY)>.  (If \<@Sinks> is omitted, then it is assumed to be empty
 which means that the object returned cannot be assigned to a variable with a sink.)

The \<getParameters> method is an example of a method that returns an object with a source.
\begin{Verbatim}
package android.hardware;
class Camera {
    @Sources(SpartaPermission.CAMERA_SETTINGS) @Sinks(SpartaPermission.ANY)
        Camera.Parameters getParameters ();
    void setParameters (@Sources(SpartaPermission.ANY) @Sinks(CAMERA_SETTINGS) 
         Camera.Parameters params);
}
\end{Verbatim}



\begin{Verbatim}
Camera.Parameters parameters
     = mCamera.getParameters();
// Change some parameters
// If the policy file contains: CAMERA_SETTINGS->CAMERA_SETTINGS
// Then the following statement will not give an error:
mCamera.setParameters(parameters);
\end{Verbatim}



\subsection{Methods with Sinks}
If you read the Javadoc for an API method an it sends some parameters to a SpartaPermission, then the parameters
should be annotated with that flow sink and ANY flow source.  

Example annotation
\begin{Verbatim}
package android.database.sqlite;
class SQLiteDatabase{
  public void execSQL (@Sinks(SpartaPermission.DATABASE) @SpartaPermission(SpartaPermission.ANY) String sql);
}
\end{Verbatim}
Use of the API
\begin{Verbatim}
@Sources(SMS,LITERAL)  String getSMSQuery(){..}
String mes = getSMSQuery();
//if SMS,LITERAL->DATABASE is in flow policy
//Then the following statement will not give an error
db.execSQL(mes);
\end{Verbatim}

\subsection{Callbacks}
The Android API frequently uses callbacks.  These are methods that the developer must 
implement and register.  In stub files, these callbacks should be annotated
with source information and SpartaPermission.ANY.  

An example annotation of a callback method
\begin{Verbatim}
package android.hardware;
class Camera$PictureCallback{
  //data: a byte array of the picture data
   void onPictureTaken 
      (@SpartaPermission(CAMERA) @Sinks(SpartaPermission.ANY) byte[] data, 
             @SpartaPermission(CAMERA) @Sinks(SpartaPermission.ANY)  Camera camera);
}
\end{Verbatim}

An example implementation of a callback
\begin{Verbatim}
public void onPictureTaken
(@SpartaPermission(CAMERA) byte[] data, @SpartaPermission(CAMERA) Camera camera){
   //If CAMERA->FILE_SYSTEM is in policy file
   //Then the following statement will not give an error
    writeToFile(data);
}
\end{Verbatim}


\subsection{Methods that Transform Data}

Some methods take the arguments passed, transform them, and then return them.  These sorts of 
methods should be annotated with \<@PolySources @PloySinks>
  to preserve the flow information.  The declaration annotation \<@PolyFlow> can be used instead of
  annotating all the parameters and return types. See Section \ref{sec:polyflow} for more information 
  
  Math.min(...) is a good example of these kinds of methods. 
  
  \begin{Verbatim}
package java.lang;
class Math{
   @PolyFlow  
   int min(int i1, int i2);
}
\end{Verbatim}

Example use of \<@PolyFlow>.
\begin{Verbatim}
@Sources(SpartaPermission.LOCATION) int i1 = getLocation();
@Sources(SpartaPermission.INTERNET) int i2 = getLocationForNetwork();
@Sources({SpartaPermission.LOCATION,SpartaPermission.INTERNET)}) int min = Math.min(i1,i2);
 \end{Verbatim}

\section{Common Errors\label{errors}}

This section explains some common errors issued by the Flow Checker, and
gives advice about correcting the errors.   

Also see the Checker Framework Manual
(\ifhevea\url{http://types.cs.washington.edu/checker-framework/current/checkers-manual.html}\else\url{http://types.cs.washington.edu/checker-framework/current/checkers-manual.pdf}\fi),
which contains information about pluggable type-checking in general.  Many
of your errors may not be specific to the Flow Checker and are likely to be
answered in the Checker Framework Manual.

If you encounter a problem you cannot solve, contact the SPARTA developers (\secref{sec:incaseoftrouble}).



\subsection{Forbidden Flow}  
Every source-sink pair in your code must be listed in the flow policy or else a \emph{forbidden flow} error will occur.
To correct a forbidden flow error, add the forbidden flow to the policy file. 
  
For example, fix the error below by adding \code{LITERAL -> FILESYSTEM} to the policy file.
\begin{Verbatim}
NewTest.java:43: error: flow forbidden by flow-policy  
        test = new @Sinks(SpartaPermission.FILESYSTEM)@Sources(SpartaPermission.LITERAL) TestClass2(fs);
                  ^
  found: @Sinks(SpartaPermission.FILESYSTEM) @Sources(SpartaPermission.LITERAL) TestClass2 
  forbidden flows:
    LITERAL -> FILESYSTEM
\end{Verbatim}

\subsection{Incompatible Types}
The most common errors are \emph{incompatible types}.  They can be in arguments,  assignment, return, etc.

\paragraph{Conservative Typing}

APIs that have not been annotated have been typed so conservatively that they will always produce incompatible types errors where the required is \<@Sinks(ANY) @Sources({})> or 
\<@Sinks({}) @Sources(ANY)>.  These errors can be fixed by annotating the API method; 
Section \ref{flow-task-annotate-apis} explains how to annotate APIs. 
Below is an example of this sort of error.

\begin{Verbatim}
HelloWorld.java:84: error: incompatible types in argument
                 .replace(R.id.container, fragment)
                                          ^
   found   : @Sinks(CONDITIONAL) @Sources(LITERAL) Fragment
   required: @Sinks(ANY) @Sources({}) Fragment
\end{Verbatim}

\paragraph{Incompatible Types}

If the incompatible types error is not from conservative defaulting, then the error must be fixed by adding or
removing annotations in the application.  For example, the error below can be fixed by adding ACCELEROMETER to the SpartaPermission of the return type.  

\begin{Verbatim}
HelloWorld.java:49: error: incompatible types in return.
       return x;
              ^
   found   : @Sinks(CONDITIONAL) @Sources({LITERAL, ACCELEROMETER}) int
   required: @Sinks(CONDITIONAL) @Sources(LITERAL) int
\end{Verbatim}

\subsection{Conditionals}
As explained in Section \ref{sec:conditionals}, any item in a conditional statement must have CONDITIONAL listed as a SpartaPermission.  If a variable is only annotated with Sources and strict conditionals are not used, then CONDITIONAL is added as a flow sink by default. 

For example, if input is a parameter in a method and is annotated with @Sinks(SpartaPermission.INTERNET), the following error will occur.  To fix the error, add CONDITIONAL to the flow sink annotation.  

\begin{Verbatim}
HelloWorld.java:48: error: Conditions are not allowed to depend on flow information.
         if(i1 > 2){
            ^
\end{Verbatim}



%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "manual"
%%% TeX-command-default: "PDF"
%%% End: 

%  LocalWords:  App flowtest Sinks Sources sparta app SpartaPermission
%  LocalWords:  reportapiusage StubGenerator getParameters PolySources
%  LocalWords:  PloySinks PolyFlow FILESYSTEM
